define(["common/js/lib/Serum.Pubsub","module"],function(t,e){"use strict";function i(){var t,i,o,n=e.config().CONTENT_ID;return 0===n.indexOf("PS*")&&(t=document.querySelector(".surrogate figure[data-video-id][data-video-source]"),o=f(t.getAttribute("data-video-id")),(i=V[t.getAttribute("data-video-source")])&&o)?i+o:n}function o(e){try{t.publish(t.topics.TRACK_FWDNAV_IMPRESSION,{item:v(e),event:k}),N.push(e)}catch(i){t.publish(t.topics.TRACK_EVENT,{category:"JS Error (forward navigation tracking, view)",action:i.message,label:"Navigation item: "+e.getAttribute("data-fwdnav-id")+" > "+i.stack,fieldsObject:{nonInteraction:!0}})}}function n(e){var i=v(e);try{t.publish(t.topics.TRACK_FWDNAV_CLICK,{item:i,event:C}),localStorage.setItem("productFieldObject",JSON.stringify(i)),localStorage.setItem("trackNextDetailView","true")}catch(i){t.publish(t.topics.TRACK_EVENT,{category:"JS Error (forward navigation tracking, click)",action:i.message,label:"Navigation item: "+e.getAttribute("data-fwdnav-id")+" > "+i.stack,fieldsObject:{nonInteraction:!0}})}}function a(){if(JSON.parse(localStorage.getItem("trackNextDetailView"))){localStorage.setItem("trackNextDetailView","false");var e=JSON.parse(localStorage.getItem("productFieldObject")),i=e.id.split(":")[1],o=s();if(o&&o.id===i)try{t.publish(t.topics.TRACK_FWDNAV_DETAIL,{item:e,event:w}),"video"===o.type?c(e,o.id):"article"===o.type&&r(e)}catch(i){t.publish(t.topics.TRACK_EVENT,{category:"JS Error (forward navigation tracking, view detail)",action:i.message,label:"Navigation item: "+e.id+" > "+i.stack,fieldsObject:{nonInteraction:!0}})}else o&&localStorage.removeItem("productFieldObject")}}function r(e){try{t.publish(t.topics.TRACK_FWDNAV_STARTED,{item:e,event:I})}catch(i){t.publish(t.topics.TRACK_EVENT,{category:"JS Error (forward navigation tracking, started)",action:i.message,label:"Navigation item: "+e.id+" > "+i.stack,fieldsObject:{nonInteraction:!0}})}}function c(e,i){localStorage.setItem("trackVideoStarted","true"),localStorage.setItem("trackVideoCompleted","true"),t.subscribe(t.topics.VIDEO_DID_PREPARE,function(t){i===t.view.getAttribute("data-video-id")&&t.player.addEventListener("playercore.playingchange",function(){var i=t.player.querySelector("nrkno-player-poster"),o=t.player.querySelector("nrkno-player-tracker");if(i&&o&&o.trackingSession&&o.trackingSession.playedTimeCollector){o.trackingSession.playedTimeCollector.onceTotalPlayingTime(3,function(){l(e)});var n=i.duration;o.trackingSession.playedTimeCollector.onceTotalPlayingTime(Math.floor(.95*n),function(){d(e)})}})})}function l(e){if(JSON.parse(localStorage.getItem("trackVideoStarted")))try{t.publish(t.topics.TRACK_FWDNAV_STARTED,{item:e,event:I}),localStorage.setItem("trackVideoStarted","false")}catch(i){t.publish(t.topics.TRACK_EVENT,{category:"JS Error (forward navigation tracking, started)",action:i.message,label:"Navigation item: "+e.id+" > "+i.stack,fieldsObject:{nonInteraction:!0}})}}function d(e){if(JSON.parse(localStorage.getItem("trackVideoCompleted")))try{t.publish(t.topics.TRACK_FWDNAV_COMPLETED,{item:e,event:O}),localStorage.setItem("trackVideoCompleted","false")}catch(i){t.publish(t.topics.TRACK_EVENT,{category:"JS Error (forward navigation tracking, completed)",action:i.message,label:"Navigation item: "+e.id+" > "+i.stack,fieldsObject:{nonInteraction:!0}})}}function s(){var t=document.querySelector(".surrogate.widget.container-widget");if(!t)return null;var e=t.getAttribute("data-id"),i=t.querySelector("figure[data-video-id]"),o=t.querySelector('article[role="main"]');if(i&&!o){var n=i.getAttribute("data-video-id");if(n)return{id:n,type:"video"}}else if(o&&e)return{id:e,type:"article"};return null}function u(t){var e=t.querySelector(".title"),i=t.getAttribute("data-fwdnav-title");return i||e&&e.textContent}function g(t){return/^\d/.test(t)}function p(t){return/^\d+$/.test(t)}function f(t){return t.replace(/^clip\//,"")}function m(t){var e=t.getAttribute("data-fwdnav-id"),o=t.getAttribute("data-fwdnav-position"),n=u(t)||e,a=t.querySelector(".plug.video [data-id][data-source]"),r=null,c="";return a&&(r=a.getAttribute("data-id"),c=V[a.getAttribute("data-source")]),o=p(o)?Number(o):void 0,{id:r?c+f(r):e,title:n,collectionId:t.getAttribute("data-fwdnav-collection-id"),parentContent:i(),position:o,collectionType:t.getAttribute("data-fwdnav-collection-type")}}function v(t){var e=m(t);return{id:g(e.id)?"pp:"+e.id:e.id,name:e.title,brand:g(e.parentContent)?"pp:"+e.parentContent:e.parentContent,list:e.collectionType,position:e.position,variant:g(e.collectionId)?"pp:"+e.collectionId:e.collectionId}}function b(t){var e=t.querySelector(".plug-image"),i=t.querySelector(".title"),o=e&&e.getBoundingClientRect(),n=i&&i.getBoundingClientRect(),a={};return o||n?o?(a.top=o.top,a.left=o.left,a.right=o.right,a.bottom=o.bottom,n&&(a.top=Math.min(a.top,n.top),a.left=Math.min(a.left,n.left),a.right=Math.max(a.right,n.right),a.bottom=Math.max(a.bottom,n.bottom)),a):n:t.getBoundingClientRect()}function S(t){var e=b(t);return e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth}function y(t){return t.children&&t.children.length>0||t.textContent}function T(t){return-1===N.indexOf(t)}function h(){return[].slice.call(document.querySelectorAll("[data-fwdnav-id]")).filter(T).filter(y).filter(S)}function A(t){setTimeout(function(){T(t)&&S(t)&&o(t)},E)}var E=2e3,N=[],k={category:"content-impressions",action:"content-impression-view",label:"view"},C={category:"content-impressions",action:"content-impression-click",label:"click"},w={category:"content-impressions",action:"content-impression-detail",label:"detail"},I={category:"content-impressions",action:"content-impression-started",label:"started"},O={category:"content-impressions",action:"content-impression-completed",label:"completed"},V={G4:"g4:",POTION:"potion:",PS:"prf:"};window.addEventListener("load",function(){h().forEach(A),a()}),document.addEventListener("scroll",function(){h().forEach(A)}),t.subscribe(t.topics.CONTENT_INSERT,function(){h().forEach(A)}),document.addEventListener("click",function(t){var e;for(e=t.target;e;e=e.parentElement)e.getAttribute("data-fwdnav-id")&&n(e)})});
//# sourceMappingURL=Serum.ForwardNavTracking.js.map