"undefined"==typeof globalThis&&(window.globalThis=window);var e=["www.nrk.no","dev.nrk.no"],n=["/"],t=[{querySelector:"[data-main-content]",getCollectionType:()=>"inline"},{querySelector:".section-reference",getCollectionType:()=>"inline"}];function r(e,n){if(void 0===n&&(n=""),!e)throw new Error("assertValid: "+n+" ("+e+")");return e}var a=0,o=["background-color: aliceblue","background-color: antiquewhite","background-color: powderblue","background-color: aquamarine"];function i(e){if(localStorage.debug){var n=o[a++];return a%=o.length,function(){for(var t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];console.log("%c"+e,n,...r)}}return()=>{}}var c=window.Element.prototype,l=c.matches||c.msMatchesSelector||c.webkitMatchesSelector;function u(e,n){return c.closest?e.closest(n):function(e,n){for(var t=e;t;t=t.parentElement)if(l.call(t,n))return t;return null}(e,n)}function f(e){if("string"==typeof e&&""!==e){var n=new URL(e).pathname,t=/(\d\.\d+)($|\/)/.exec(n);return t&&t[1]}}function d(e){var n=new URL(e).pathname,t=n.lastIndexOf("-1."),r=n.slice(0,t),a=r.lastIndexOf("/");return r.slice(a+1).replace(/_/g,"").replace(/(--)|(-)/g," ")}function v(e){return null!=e}function s(e){try{return new URL(e)}catch(e){return}}function w(e,n){return n.includes(e.hostname)}var p=i("nrkno-viderenavigasjon:ec-appending");function h(){if(n=location.href,a=w(r(s(n)),e),o="string"==typeof f(n),a&&o){var n,a,o,i=t.flatMap(g).flatMap(y);p("appending to",i),i.forEach(m)}else p("will not add EC to current page",location.href)}function m(e){var n,t,{anchor:r,ecAttributes:a}=e;r.hasAttribute("data-fwdnav-id")||(n=r,t=a,Object.entries(t).forEach((e=>{var[t,r]=e;n.setAttribute(t,r)})))}function g(e){return Array.from(document.querySelectorAll(e.querySelector)).map((n=>({element:n,selector:e})))}function y(t){var{selector:r,element:a}=t,o=r.getCollectionType(a),i=a.querySelectorAll("a[href]:not([data-fwdnav-id])"),c=Array.from(i).filter((t=>function(t){var r=-1===t.indexOf("#fact-"),a=s(t);if(void 0===a)return!1;var o=w(a,e),i=function(e,t){return n.some((n=>e.pathname.startsWith(n)))}(a);return r&&o&&i}(t.href))).filter((e=>null===u(e,"[data-fwdnav-id]"))).map(((e,n)=>function(e,n,t){var r=f(e.href);if(!r)return;var a=""+(n+1);return{anchor:e,ecAttributes:{"data-fwdnav-id":r,"data-fwdnav-title":d(e.href),"data-fwdnav-position":a,"data-fwdnav-collection-id":"N/A","data-fwdnav-collection-type":t}}}(e,n,o))).filter(v);return c}var b=["www.nrk.no","dev.nrk.no"];var k=i("nrkno-viderenavigasjon:ec-consumption");function A(){var e=function(e,n){var t=new URL(e),r=t.searchParams,a={};for(var o of n){var i=r.get(o);a[o]=i||"",r.delete(o)}return t.search=r.toString(),{url:t,params:a}}(location.href,["fwdnav"]),n=e.params.fwdnav;n&&""!==n&&(k("consumed",e.params),history.replaceState(history.state,document.title,e.url.href),function(e){localStorage.setItem("ec-fwdnav-key",e)}(n))}function S(e){var n=!1;return function(){if(!n)return n=!0,e(...arguments)}}function E(e,n){var t=setTimeout(e,n);return function(){clearTimeout(t)}}function O(){return Array.from(document.querySelectorAll("[data-fwdnav-id]")).map(q).filter(v).filter(I)}function q(e){var n="a[href]";return e.matches(n)?e:e.querySelector(n)}function I(e){var n=s(e.href);return!!n&&w(n,b)}function x(e){if(!e.href.includes("fwdnav")){var n=(""+Math.random()).slice(2),t=function(e,n){var t=new URL(e),r=Object.entries(n);for(var[a,o]of r)t.searchParams.append(a,o);return t}(e.href,{fwdnav:n});e.href=t.href,e.setAttribute("data-fwdnav-id-ref",n)}}var L=i("nrkno-viderenavigasjon:append-fwdnav");function j(){var e=location.href,n=function(e){return w(r(s(e)),b)&&"string"==typeof f(e)}(e);if(n){var t=O();L("appending fwdnav to",t),t.forEach(x),function(e){var{onAnchorOpened:n,debug:t=(()=>{})}=e;function r(e){var{key:r,newValue:a}=e;if("ec-fwdnav-key"===r&&a){var o=document.querySelector('a[data-fwdnav-id-ref="'+e.newValue+'"]');o?(t("opened in new tab",o),n(o)):t("Not _this_ tab that opened the _new tab_ (or invalid id) "+a),localStorage.removeItem(r)}else t("ignoring ("+r+", "+a+") change")}window.addEventListener("storage",r)}({onAnchorOpened:T,debug:L})}else L("skipping",e)}function T(e){var n="data-fwdnav-collection-id",t=u(e,"[data-fwdnav-collection-id]")||e,r=t.getAttribute(n)||"N/A";"N/A"===r&&(t.setAttribute(n,"contextmenu"),L("setting contextmenu"));var a=S((e=>{L("preventDefaultOnce"),e.preventDefault(),o()})),o=S((()=>{e.removeEventListener("click",a),E((()=>{L("resetting data-fwdnav-collection-id"),t.setAttribute(n,r)}),1)}));e.addEventListener("click",a),E(o,500),L("simulating click"),e.click()}function M(){return M=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e},M.apply(this,arguments)}function R(e){return new Promise(((n,t)=>{!function(e){var{callback:n,maxWait:t,pollInterval:r,test:a}=e,o=n,i=n;a()&&o();var c=E((()=>{clearInterval(l),i(new Error("waitFor: timeout"))}),t),l=setInterval((()=>{a()&&(clearInterval(l),c(),o())}),r)}(M({},e,{callback:e=>{e?t(e):n()}}))}))}!async function(){A(),await R({maxWait:15e3,pollInterval:500,test:()=>"complete"===document.readyState}),h(),j()}();
